// ==UserScript==
// @name         è±†åŒ…åŸå›¾/è§†é¢‘ä¸‹è½½å™¨ Lite v1.0
// @namespace    doubao-lite-downloader
// @version      0.2.0
// @description  åŠ«æŒ JSON.parse æ•è· creations åŸå›¾(raw)ä¸ play_info è§†é¢‘é“¾æ¥ï¼Œæ”¯æŒå¯è§†åŒ–å‹¾é€‰ä¸‹è½½/å¤åˆ¶ï¼ŒUI æ›´ç¾è§‚ï¼ˆShadow DOMï¼‰
// @match        https://www.doubao.com/*
// @run-at       document-start
// @grant        GM_download
// @grant        GM_addStyle
// @grant        unsafeWindow
// @icon         https://temp.fenx.top/temp/20260101/34d365cc810a0bc430136961ca4e61f7.png
// ==/UserScript==

(() => {
  'use strict';

  // -------------------- State --------------------
  const state = {
    items: [], // { id, type:'image'|'video', url, ts }
    byUrl: new Map(), // url -> item
    selected: new Set(), // id
    open: true,
    tab: 'image', // image | video | all
    query: '',
  };

  const MAX_RENDER = 200; // é˜²æ­¢åˆ—è¡¨å¤ªé•¿å¡
  const ID_PREFIX = 'dbdl_';

  const now = () => Date.now();

  function uid() {
    return ID_PREFIX + Math.random().toString(36).slice(2) + '_' + now().toString(36);
  }

  // -------------------- DOM / UI (Shadow DOM) --------------------
  let host, root, els = {};

  function mountUI() {
    if (host) return;

    host = document.createElement('div');
    host.id = 'dbdl-host';
    host.style.all = 'initial';
    host.style.position = 'fixed';
    host.style.right = '16px';
    host.style.bottom = '16px';
    host.style.zIndex = '2147483647';

    root = host.attachShadow({ mode: 'open' });

    root.innerHTML = `
      <style>
        :host { all: initial; }
        .fab {
          width: 46px; height: 46px;
          border-radius: 16px;
          display: none;
          background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
          border: 1px solid rgba(255,255,255,.15);
          backdrop-filter: blur(10px);
          color: white;
          cursor: pointer;
          box-shadow: 0 12px 30px rgba(0,0,0,.35);
          font: 600 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial;
          letter-spacing: .4px;
          user-select: none;
        }
        .panel {
          width: 360px;
          max-height: 76vh;
          border-radius: 18px;
          overflow: hidden;
          background: rgba(18,18,20,.92);
          border: 1px solid rgba(255,255,255,.10);
          backdrop-filter: blur(12px);
          box-shadow: 0 18px 45px rgba(0,0,0,.40);
          color: rgba(255,255,255,.92);
          font: 12px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }
        .header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 12px 10px;
          border-bottom: 1px solid rgba(255,255,255,.08);
        }
        .title {
          display:flex; flex-direction: column; gap: 3px;
        }
        .title b { font-size: 13px; }
        .meta { font-size: 11px; opacity:.75; }
        .actions {
          display:flex; gap: 8px; align-items:center;
        }
        .iconbtn {
          width: 32px; height: 32px;
          border-radius: 12px;
          border: 1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.08);
          color: rgba(255,255,255,.92);
          cursor:pointer;
        }
        .iconbtn:hover { background: rgba(255,255,255,.12); }
        .body { padding: 10px 12px 12px; display: grid; gap: 10px; }
        .tabs {
          display:flex; gap: 8px;
        }
        .tab {
          flex:1;
          border: 1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.06);
          border-radius: 12px;
          padding: 8px 10px;
          cursor:pointer;
          text-align:center;
          user-select:none;
        }
        .tab.active { background: rgba(255,255,255,.14); }
        .toolbar {
          display:grid; gap: 8px;
        }
        .search {
          display:flex; gap: 8px; align-items:center;
          border: 1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.06);
          border-radius: 12px;
          padding: 8px 10px;
        }
        .search input {
          all: unset;
          flex: 1;
          color: rgba(255,255,255,.92);
          font-size: 12px;
        }
        .btnrow { display:flex; gap: 8px; flex-wrap: wrap; }
        .btn {
          border: 1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.08);
          color: rgba(255,255,255,.92);
          border-radius: 12px;
          padding: 8px 10px;
          cursor:pointer;
          user-select:none;
          font-size: 12px;
        }
        .btn:hover { background: rgba(255,255,255,.12); }
        .btn.primary { background: rgba(72,120,255,.22); border-color: rgba(72,120,255,.35); }
        .btn.danger  { background: rgba(255,72,72,.20); border-color: rgba(255,72,72,.32); }
        .list {
          border: 1px solid rgba(255,255,255,.10);
          background: rgba(255,255,255,.05);
          border-radius: 14px;
          overflow: hidden;
        }
        .listHeader {
          display:flex; justify-content: space-between; align-items:center;
          padding: 8px 10px;
          border-bottom: 1px solid rgba(255,255,255,.08);
          font-size: 11px;
          opacity:.85;
        }
        .items {
          max-height: 38vh;
          overflow: auto;
        }
        .item {
          display:grid;
          grid-template-columns: 18px 44px 1fr;
          gap: 10px;
          padding: 10px;
          border-bottom: 1px solid rgba(255,255,255,.06);
          align-items: center;
        }
        .item:last-child { border-bottom: none; }
        .chk { width: 16px; height:16px; cursor:pointer; }
        .thumb {
          width: 44px; height: 44px;
          border-radius: 12px;
          overflow:hidden;
          background: rgba(255,255,255,.08);
          border: 1px solid rgba(255,255,255,.10);
          display:flex; align-items:center; justify-content:center;
          user-select:none;
        }
        .thumb img { width:100%; height:100%; object-fit: cover; display:block; }
        .thumb .badge {
          font-size: 10px;
          opacity:.8;
        }
        .info { display:flex; flex-direction: column; gap: 4px; min-width:0; }
        .url {
          font-size: 11px;
          opacity: .88;
          overflow:hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          cursor: pointer;
        }
        .sub {
          display:flex; gap: 8px; align-items:center;
          font-size: 10px;
          opacity:.70;
        }
        .pill {
          padding: 2px 6px;
          border-radius: 999px;
          border: 1px solid rgba(255,255,255,.12);
          background: rgba(255,255,255,.06);
        }
        .toast {
          position: absolute;
          right: 10px;
          top: 10px;
          padding: 8px 10px;
          border-radius: 12px;
          background: rgba(0,0,0,.55);
          border: 1px solid rgba(255,255,255,.10);
          color: rgba(255,255,255,.92);
          font-size: 11px;
          display:none;
        }
      </style>

      <button class="fab" id="fab">DB</button>

      <div class="panel" id="panel">
        <div class="header">
          <div class="title">
            <b>è±†åŒ…ä¸‹è½½å™¨ Lite</b>
            <div class="meta" id="meta">å‡†å¤‡ä¸­â€¦</div>
          </div>
          <div class="actions">
            <button class="iconbtn" id="collapse" title="æ”¶èµ·">â€“</button>
          </div>
        </div>

        <div class="body">
          <div class="tabs">
            <div class="tab active" data-tab="image">åŸå›¾</div>
            <div class="tab" data-tab="video">è§†é¢‘</div>
            <div class="tab" data-tab="all">å…¨éƒ¨</div>
          </div>

          <div class="toolbar">
            <div class="search">
              <span style="opacity:.75;font-size:11px;">ğŸ”</span>
              <input id="query" placeholder="æœç´¢ URL ç‰‡æ®µï¼ˆä¾‹å¦‚ jpg / png / mp4ï¼‰" />
              <button class="iconbtn" id="clearQuery" title="æ¸…ç©º">Ã—</button>
            </div>

            <div class="btnrow">
              <button class="btn" id="selAll">å…¨é€‰</button>
              <button class="btn" id="selNone">å…¨ä¸é€‰</button>
              <button class="btn" id="selInvert">åé€‰</button>
              <button class="btn" id="selVisible">åªé€‰å½“å‰åˆ—è¡¨</button>
            </div>

            <div class="btnrow">
              <button class="btn primary" id="dlSelected">ä¸‹è½½é€‰ä¸­</button>
              <button class="btn" id="copySelected">å¤åˆ¶é€‰ä¸­</button>
              <button class="btn danger" id="removeSelected">åˆ é™¤é€‰ä¸­</button>
              <button class="btn" id="clearAll">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
          </div>

          <div class="list">
            <div class="listHeader">
              <div>åˆ—è¡¨ï¼ˆæœ€å¤šæ¸²æŸ“ ${MAX_RENDER} æ¡ï¼‰</div>
              <div id="count">0</div>
            </div>
            <div class="items" id="items"></div>
          </div>
        </div>
        <div class="toast" id="toast"></div>
      </div>
    `;

    document.documentElement.appendChild(host);

    // cache elements
    els = {
      panel: root.querySelector('#panel'),
      fab: root.querySelector('#fab'),
      meta: root.querySelector('#meta'),
      count: root.querySelector('#count'),
      items: root.querySelector('#items'),
      toast: root.querySelector('#toast'),
      query: root.querySelector('#query'),
      clearQuery: root.querySelector('#clearQuery'),
      collapse: root.querySelector('#collapse'),
      tabs: [...root.querySelectorAll('.tab')],
      selAll: root.querySelector('#selAll'),
      selNone: root.querySelector('#selNone'),
      selInvert: root.querySelector('#selInvert'),
      selVisible: root.querySelector('#selVisible'),
      dlSelected: root.querySelector('#dlSelected'),
      copySelected: root.querySelector('#copySelected'),
      removeSelected: root.querySelector('#removeSelected'),
      clearAll: root.querySelector('#clearAll'),
    };

    // events
    els.collapse.onclick = () => setOpen(false);
    els.fab.onclick = () => setOpen(true);

    els.tabs.forEach(t => {
      t.onclick = () => {
        state.tab = t.dataset.tab;
        els.tabs.forEach(x => x.classList.toggle('active', x.dataset.tab === state.tab));
        render();
      };
    });

    els.query.oninput = () => {
      state.query = els.query.value.trim().toLowerCase();
      render();
    };
    els.clearQuery.onclick = () => {
      els.query.value = '';
      state.query = '';
      render();
    };

    els.selAll.onclick = () => selectAllVisible(true);
    els.selNone.onclick = () => selectAllVisible(false);
    els.selInvert.onclick = () => invertVisible();
    els.selVisible.onclick = () => selectOnlyVisible();

    els.clearAll.onclick = () => {
      state.items = [];
      state.byUrl.clear();
      state.selected.clear();
      toast('å·²æ¸…ç©ºå…¨éƒ¨');
      render();
    };

    els.removeSelected.onclick = () => {
      if (!state.selected.size) return toast('è¿˜æ²¡é€‰ä»»ä½•æ¡ç›®');
      const s = new Set(state.selected);
      state.items = state.items.filter(it => !s.has(it.id));
      // rebuild map
      state.byUrl.clear();
      for (const it of state.items) state.byUrl.set(it.url, it);
      state.selected.clear();
      toast('å·²åˆ é™¤é€‰ä¸­');
      render();
    };

    els.copySelected.onclick = async () => {
      const urls = getSelectedItems().map(x => x.url);
      if (!urls.length) return toast('è¿˜æ²¡é€‰ä»»ä½•æ¡ç›®');
      await copyText(urls.join('\n'));
      toast(`å·²å¤åˆ¶ ${urls.length} æ¡é“¾æ¥`);
    };

    els.dlSelected.onclick = async () => {
      const items = getSelectedItems();
      if (!items.length) return toast('è¿˜æ²¡é€‰ä»»ä½•æ¡ç›®');
      toast(`å¼€å§‹ä¸‹è½½ ${items.length} ä¸ªâ€¦`);
      await downloadMany(items);
      toast('ä¸‹è½½ä»»åŠ¡å·²æäº¤');
    };

    setOpen(true);
    render();
    toast('å·²å¯åŠ¨ï¼šç­‰å¾…æŠ“å–é“¾æ¥â€¦');
  }

  function setOpen(open) {
    state.open = open;
    if (!els.panel) return;
    els.panel.style.display = open ? 'block' : 'none';
    els.fab.style.display = open ? 'none' : 'block';
  }

  function toast(msg) {
    if (!els.toast) return;
    els.toast.textContent = msg;
    els.toast.style.display = 'block';
    clearTimeout(toast._t);
    toast._t = setTimeout(() => { els.toast.style.display = 'none'; }, 1600);
    refreshMeta();
  }

  function refreshMeta() {
    if (!els.meta) return;
    const total = state.items.length;
    const img = state.items.filter(x => x.type === 'image').length;
    const vid = state.items.filter(x => x.type === 'video').length;
    const sel = state.selected.size;
    els.meta.textContent = `æ€» ${total} Â· å›¾ ${img} Â· è§†é¢‘ ${vid} Â· å·²é€‰ ${sel}`;
  }

  // -------------------- Filtering / Rendering --------------------
  function getVisibleItems() {
    let arr = state.items;

    if (state.tab !== 'all') {
      arr = arr.filter(it => it.type === state.tab);
    }
    if (state.query) {
      arr = arr.filter(it => it.url.toLowerCase().includes(state.query));
    }
    // newest first
    arr = [...arr].sort((a,b) => b.ts - a.ts);
    return arr.slice(0, MAX_RENDER);
  }

  function render() {
    if (!els.items) return;

    const visible = getVisibleItems();
    els.count.textContent = `${visible.length}/${state.items.length}`;

    els.items.innerHTML = '';

    for (const it of visible) {
      const row = document.createElement('div');
      row.className = 'item';

      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.className = 'chk';
      chk.checked = state.selected.has(it.id);
      chk.onchange = () => {
        if (chk.checked) state.selected.add(it.id);
        else state.selected.delete(it.id);
        refreshMeta();
      };

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      if (it.type === 'image') {
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.referrerPolicy = 'no-referrer';
        img.src = it.url;
        img.onerror = () => {
          thumb.innerHTML = `<span class="badge">IMG</span>`;
        };
        thumb.appendChild(img);
      } else {
        thumb.innerHTML = `<span class="badge">VIDEO</span>`;
      }

      const info = document.createElement('div');
      info.className = 'info';

      const url = document.createElement('div');
      url.className = 'url';
      url.textContent = it.url;
      url.title = 'ç‚¹å‡»å¤åˆ¶è¿™æ¡é“¾æ¥';
      url.onclick = async () => {
        await copyText(it.url);
        toast('å·²å¤åˆ¶è¿™æ¡é“¾æ¥');
      };

      const sub = document.createElement('div');
      sub.className = 'sub';
      const pill1 = document.createElement('span');
      pill1.className = 'pill';
      pill1.textContent = it.type === 'image' ? 'åŸå›¾' : 'è§†é¢‘';
      const pill2 = document.createElement('span');
      pill2.className = 'pill';
      pill2.textContent = new Date(it.ts).toLocaleTimeString();

      sub.appendChild(pill1);
      sub.appendChild(pill2);

      info.appendChild(url);
      info.appendChild(sub);

      row.appendChild(chk);
      row.appendChild(thumb);
      row.appendChild(info);

      els.items.appendChild(row);
    }

    refreshMeta();
  }

  function selectAllVisible(checked) {
    const visible = getVisibleItems();
    for (const it of visible) {
      if (checked) state.selected.add(it.id);
      else state.selected.delete(it.id);
    }
    render();
    toast(checked ? 'å·²å…¨é€‰å½“å‰åˆ—è¡¨' : 'å·²å–æ¶ˆå½“å‰åˆ—è¡¨é€‰æ‹©');
  }

  function invertVisible() {
    const visible = getVisibleItems();
    for (const it of visible) {
      if (state.selected.has(it.id)) state.selected.delete(it.id);
      else state.selected.add(it.id);
    }
    render();
    toast('å·²åé€‰å½“å‰åˆ—è¡¨');
  }

  function selectOnlyVisible() {
    const visible = getVisibleItems();
    state.selected.clear();
    for (const it of visible) state.selected.add(it.id);
    render();
    toast('åªé€‰æ‹©å½“å‰åˆ—è¡¨');
  }

  function getSelectedItems() {
    const s = state.selected;
    return state.items.filter(it => s.has(it.id));
  }

  // -------------------- Capture (inject JSON.parse hook into page context) --------------------
  function injectParseHook() {
    const code = `
      (function(){
        const prevImages = new Set();
        const prevVideos = new Set();

        function findAllKeys(obj, key, out){
          out = out || [];
          if (!obj || typeof obj !== 'object') return out;
          if (Array.isArray(obj)) { for (const it of obj) findAllKeys(it, key, out); return out; }
          for (const k of Object.keys(obj)) {
            const v = obj[k];
            if (k === key) out.push(v);
            findAllKeys(v, key, out);
          }
          return out;
        }

        const origin = JSON.parse;
        JSON.parse = function(data){
          const json = origin.apply(this, arguments);

          // video
          try {
            if (typeof data === 'string' && data.includes('play_info')) {
              const playInfos = findAllKeys(json, 'play_info');
              if (playInfos && playInfos.length) {
                const playUrl = playInfos[0] && playInfos[0].main;
                if (playUrl && !prevVideos.has(playUrl)) {
                  prevVideos.add(playUrl);
                  window.dispatchEvent(new CustomEvent('__DBDL_FOUND__', { detail: { type: 'video', url: playUrl }}));
                }
              }
            }
          } catch(e){}

          // images
          try {
            if (!(typeof data === 'string' && data.includes('creations'))) return json;

            const creationsList = findAllKeys(json, 'creations');
            if (creationsList && creationsList.length) {
              const found = [];
              creationsList.forEach((creation) => {
                if (!Array.isArray(creation)) return;
                creation.forEach((item) => {
                  const rawUrl = item && item.image && item.image.image_ori_raw && item.image.image_ori_raw.url;
                  if (rawUrl) {
                    // è¦†ç›–å°ºå¯¸ urlï¼šè¿™æ˜¯â€œç²¾åâ€åšæ³•
                    if (item.image.image_ori) item.image.image_ori.url = rawUrl;
                    if (item.image.image_preview) item.image.image_preview.url = rawUrl;
                    if (item.image.image_thumb) item.image.image_thumb.url = rawUrl;

                    if (!prevImages.has(rawUrl)) {
                      prevImages.add(rawUrl);
                      found.push(rawUrl);
                    }
                  }
                });
              });
              found.forEach((u) => {
                window.dispatchEvent(new CustomEvent('__DBDL_FOUND__', { detail: { type: 'image', url: u }}));
              });
            }
          } catch(e){}

          return json;
        };

        window.addEventListener('__DBDL_UNHOOK__', () => { JSON.parse = origin; });
      })();
    `;

    const s = document.createElement('script');
    s.textContent = code;
    document.documentElement.appendChild(s);
    s.remove();
  }

  function onFound(evt) {
    const { type, url } = (evt && evt.detail) || {};
    if (!url || (type !== 'image' && type !== 'video')) return;

    if (state.byUrl.has(url)) return; // dedupe
    const it = { id: uid(), type, url, ts: now() };
    state.byUrl.set(url, it);
    state.items.push(it);

    // é»˜è®¤ï¼šæ–°æŠ“åˆ°çš„è‡ªåŠ¨å‹¾é€‰ï¼ˆæ›´é¡ºæ‰‹ï¼‰
    state.selected.add(it.id);

    // å»¶è¿Ÿ mount UIï¼ˆdocument-start ä¸‹ï¼‰
    if (!host) mountUI();
    render();
  }

  // -------------------- Download helpers --------------------
  function safeFileName(prefix, url, idx) {
    try {
      const u = new URL(url);
      const base = u.pathname.split('/').pop() || 'file';
      const clean = base.replace(/[^\w.\-]+/g, '_');
      return `${prefix}_${String(idx + 1).padStart(3, '0')}_${clean}`;
    } catch {
      return `${prefix}_${String(idx + 1).padStart(3, '0')}_${Date.now()}`;
    }
  }

  async function downloadMany(items) {
    // ç¨å¾®é™é€Ÿä¸€ä¸‹ï¼Œé¿å…æµè§ˆå™¨/ç«™ç‚¹æ‹¦æˆª
    for (let i = 0; i < items.length; i++) {
      const it = items[i];
      const prefix = it.type === 'image' ? 'doubao-image' : 'doubao-video';
      const name = safeFileName(prefix, it.url, i);

      await new Promise((resolve) => {
        GM_download({
          url: it.url,
          name,
          saveAs: false,
          onload: () => resolve(),
          onerror: () => resolve(),
          ontimeout: () => resolve(),
        });
      });

      await new Promise(r => setTimeout(r, 220));
    }
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      // fallback
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '-9999px';
        document.documentElement.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        return true;
      } catch {
        return false;
      }
    }
  }

  // -------------------- Boot --------------------
  function boot() {
    injectParseHook();
    window.addEventListener('__DBDL_FOUND__', onFound, false);

    // UI åœ¨é¦–æ¬¡æŠ“åˆ°é“¾æ¥æ—¶å†æŒ‚ï¼ˆæ›´è½»ï¼‰
    // ä½†ä½ ä¹Ÿå¯ä»¥å¼ºåˆ¶æå‰æŒ‚ï¼šè¿™é‡Œç•™ä¸ªå®šæ—¶å™¨å…œåº•
    const t = setInterval(() => {
      if (!host && document.documentElement) {
        mountUI();
        clearInterval(t);
      }
    }, 600);
  }

  boot();
})();
